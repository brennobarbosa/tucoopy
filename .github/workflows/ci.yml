name: ci

on:
  push:
  pull_request:

jobs:
  test-min:
    name: test (min) - ${{ matrix.os }} / py${{ matrix.python-version }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest]
        python-version: ["3.10", "3.11", "3.12", "3.13"]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements-docs.txt

      - name: Install (editable)
        run: |
          python -m pip install -U pip
          python -m pip install -e ".[dev,docs]"

      - name: Case-collision check (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $files = git ls-files
          $map = @{}
          foreach ($f in $files) {
            $k = $f.ToLowerInvariant()
            if (-not $map.ContainsKey($k)) { $map[$k] = @() }
            $map[$k] += $f
          }
          $collisions = $map.GetEnumerator() | Where-Object { $_.Value.Count -gt 1 }
          if ($collisions) {
            Write-Host "Found case-colliding paths:"
            foreach ($c in $collisions) {
              Write-Host ("- " + ($c.Value -join ", "))
            }
            exit 1
          }

      - name: Reject placeholder files
        shell: bash
        run: |
          set -euo pipefail
          if rg -n "^[[:space:]]*#\\s*apagar\\b" src/tucoopy -S; then
            echo "Found placeholder '# apagar' files. Remove them or replace with an explicit ImportError module."
            exit 1
          fi

      - name: Pytest
        run: |
          python -m pytest -q tests

      - name: Mypy
        run: |
          python -m mypy src/tucoopy

      - name: MkDocs (pt)
        if: runner.os == 'Linux'
        run: |
          python -m mkdocs build -f mkdocs.pt.yml --clean

  test-full:
    name: test (full extras) - ubuntu / py3.12
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: pip
          cache-dependency-path: |
            pyproject.toml
            requirements-docs.txt

      - name: Install (editable + extras)
        run: |
          python -m pip install -U pip
          python -m pip install -e ".[dev,docs,lp,fast,viz]"

      - name: Pytest
        run: |
          python -m pytest -q tests
